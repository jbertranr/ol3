
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
    <head>
        <title>Apps per accedir a la Cartografia</title>
        <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1"> 
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" /> 
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.9.0/ol.min.css" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">    
        <style>               
            .leaflet-control-locate {display:none}
            
            #portada{
                width:100%;
                height:100%;
                margin:0px;
                background-color:#f0cd2a;
            }
            
			#fotoPortada{
                width:100%;
                height:100%;
                margin:0px;              
            }              
            
            @font-face {
                font-family: "novaFont";
                src: url("./fonts/Lato-Regular.ttf");
            }
            
            #map { 
                height: 100%;
                width:100%; 
            }
            
            #mapDetail { 
                margin:-15px;
                height: 100%;
                width:100%; 
            }
            
            #POIDetail {
                height: 10%;
                width:100%; 
            }
            
            
            .cub{
                font-weight:bold;
                text-shadow:none;
                background-color: transparent;
                text-align:center; 
                height:35px;
                margin-top: 0em; 
                margin-left:0em;
                float: left; 
                color: rgb(244, 244, 244); 
                font-family:novaFont;
                width: 80px;
                    
            }
            
            
            .controlMapa-junt {
                margin-top: 1px;
            }

			.controlMapa {
				background-color: #656565;
				border-radius: 5px 0 0 5px;
				color: #ffffff;
				cursor: pointer;
				font-family: verdana;
				font-size: 33px;
				font-weight: bold;
				height: 45px;
				opacity: 0.93;
				text-align: center;
				width: 40px;
				z-index: 999999;
			}
			
            .controlMapa:hover {opacity:0.97}

            .controlMapa-separat {margin-top:5px}
            
            .caixaControl{ z-index:5000;position:fixed;right:0px;top:60px; }

            .caixaControlInferior {
                position: fixed;
                right: 0;
                top: 201px;
                z-index: 5000;
            }
            .cubTitol { font-size: 0.8em;  height: 6px; width:100%;margin-top:5px;font-family:novaFont;  }
            .cubValor { margin-top:0.2em;font-size: 1.8em;  height: 26px; ; color: #ffffff;width:100%;font-family:novaFont; }
            .cubUnitat { margin-bottom:7px;font-size:0.8em;margin-top:0em;height:15px;font-family:novaFont; }
            
            .cubPetit{
                font-weight:bold;
                text-shadow:none;
                background-color: #ffffff;
                text-align:center; 
                height:37px;                
                float: left; 
                color: rgb(244, 244, 244); 
                font-family:novaFont; 
                width: 80px;
                margin:0;
            }
            
            .cubGran{
                font-weight:bold;
                text-shadow:none;
                background-color: #ffffff;
                text-align:center; 
                height:74px;                
                float: left; 
                color: rgb(244, 244, 244); 
                font-family:Helvetica;
                width: 80px;
                margin:0;
                font-family: novaFont;
            }
            .cubPetitTitol { font-size: 0.6em;  height: 6px; width:100%;margin-top:0px;font-family:novaFont  }
            .cubPetitValor {margin-top:0 em;font-size: 1.2em;  height: 18px; ; color: #ffffff;width:100%;font-family:novaFont }
            .cubPetitUnitat {margin-bottom:7px;font-size:0.6em;margin-top:0em;height:10px;font-family:novaFont }
            .cubsContenidor { width:100%;height:125px;clear:both;border-bottom: 1px dotted #dddddd;overflow:hidden; padding-bottom:4px;}
            .iconWrapper { float:right;margin-right:30px;margin-top:15px}
            
            
        </style>

		<script src="phonegap.js"></script>
        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.9.0/ol.min.js"></script> 
        <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.14/proj4.js"></script>    
        <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>         
       
        
        <script type="text/javascript"> 

            var visor = {
                'projection' : null,
                'geolocation' : null,
                'geolocationIconStyle' : null,
                'actiu' : 0,
                'markerGroupPosActual': null,
                'markerGroupPosActualDetail': null,
                'markerGroup': null,
                'markerGroupDetail': null,
                'llistaInicial': 0,
                'map' : {}, //  Objecte Leaflet del mapa
                'mapDetail' : {}, //    Objecte Leaflet del mapa Detall
                'wpid' : 0,
                'modeNavegacio' : null,
                'modePunt' : null,
                'nouPuntEdicio': null,
                'popup' : null,
                'greenIcon' : {},
                'valoracio' : null,
                'icon' : null,
                'markerPosicioActual' : {},
                'markerPosicioActualPresent' : '0',
                'config' : { 'layers' : { 'base' : [], 'overlay' : [] }},
                'posicioActual' : { 'trobat': 0, 'lat' : 0, 'lng' : 0, 'alt' : 0, 'acc' : 0 },
                'posicioAnterior' : { 'trobat': 0, 'lat' : 0,   'lng' : 0, 'alt' : 0, 'acc' : 0 },
                'POI' : [{  'nom' : null , 'descripcio': null , 'lat': null , 'lng':null, 'tema' : null, 'icona' : null , 'seleccionat' : 0, 'distancia' : null}],
                'filtre' : {  'seleccionat' : 0 , 'valoracioMin':0, 'valoracioMax': 100, 'categoria': 'platja.png', 'distancia': 40000 },
                'cerclePrecisio':null,
                'capaPosicio':null,
                'posicioActual':0,
                'watchID':{},
                'locate':{},
                'totMarker': null,
                'posicioCamera':{},
                'markerCamera':{},
                'data':{},
                'adrecaOSM':null,
				'params':null,
                'primeraUbicació' :  1
            };
            
            //
            //document.addEventListener("deviceready", onDeviceReady, false);


            //$( document ).on('pagebeforehide' ,'#pagetwo', function(){ 
            //  carregaDades();
            //});   
            
            //-- Paràmetres d'inicialització
            
            //-- Totes les pantalles
            
            $( window ).on( 'orientationchange', function( event ) {ajustaPortada();});                 
            
            
            //-- Inicialització Portada     
            
            $( document ).on('beforepageshow' ,'#portada', function(){ 
                $(window).bind('resize', function (){   ajustaFinestres();
                                                        ajustaPortada();  
                                                     });
                $.mobile.page.prototype.options.theme = "a";                    
                $('#pageMap').trigger('pagecreate');
                if (visor.actiu == 0){
                    inicialitzaMapa(); 
                    visor.actiu = 1;    
                }    
            });
             
            //-- Inicia pageMap                    
            $( document ).on('pageshow','#pageMap', function(){
                inicialitzaMapa(); 
                ajustaFinestres(); 
				//recuperaElements();	
            });
            
            $(window).bind('resize', function () {ajustaFinestres();});
            
            $("#peuMapa").on("swipe", function (evt) {
                missatgePeuMapa( 'fesFoto' )  ; 
                ajustaFinestres();
            });
            
            
            //-- Inicia llistaElements          
            $( document ).on('pagebeforeshow','#llistaElements', function(){
                //ajustaFinestres();
                //creaRelacioPunts(); Bloquejat l'accés al detall
            });         
            
            //function onDeviceReady() {
                //navigator.geolocation.getCurrentPosition(onSuccess, onError);
                 //alert('Activa GPS');
                // treure navigator.geolocation.getCurrentPosition(successGeo, onErrorPlug, { maximumAge: 3000, timeout: 5000, enableHighAccuracy: true });
            //}
            
            //-- Intentar fer tots els ajustaments en aquesta funció
            function ajustaFinestres(){         
                
                var resizeTimer = null;         
                if (resizeTimer) clearTimeout(resizeTimer);         
                //if($("#peuMapa").is(':visible')) { var alcPeuMapa =  $('#peuMapa').height() } else {var alcPeuMapa = 0}
                resizeTimer = setTimeout(function () {
                    $('#map').width($(window).width());
                    $('#map').height($(window).height() - $('#header').height() - $('#peuMapa').height() - 5); //abans -3
                    $('#pageListContent').height($(window).height() - $('#pageListHeader').height() - $('#pageListFooter').height() - 89);
                    //visor.map._onResize(); 
                    visor.map.updateSize(); // Gentileza ol3
                },200);
               
            }
            
            //-- Ajusta la imatge de Portada al tamany dels dispositiu - Pendent no distorsionar la imatge
            function ajustaPortada(){           
                /*
                var resizeTimer = null;         
                if (resizeTimer) clearTimeout(resizeTimer);         
                resizeTimer = setTimeout(function () {
                    $('#fotoPortada').height($(window).height());               
                });
                */
            }
            
            function actualitzaFormulari(){ }
            //-- Funcions del mapa
            //-- Inicialització del mapa 
			
            function inicialitzaMapa(){
                visor.projection = 'EPSG:23031';
                proj4.defs( visor.projection, "+proj=utm +zone=31 +ellps=intl +units=m +no_defs");
                var tms_resolutions_23031_catalunya = [10, 5, 2, 1, 0.5,0.25, 0.15];
                var extent_23031_catalunya =  [258000, 4485000, 536000, 4752000];
                var opcionsBase= 'googleder';
                // visor.map.setView([41.37, 2.15], 12);   
                
                switch (opcionsBase){
                    
                    case 'mapbox':           
                     //   var capa = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                     //               attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                     //   });
                        break;
                    
                    case 'googleSat':
                     //   var capa = new L.Google('');
                        break;
                
                    case 'google':
                     //   var capa = new L.Google('map');
                        break;   
                    
                    default : // La capa base correspon a la capa de la guia urbana en format TMS
                        var capa1 = new ol.layer.Tile({
                            preload: 1,
                            source: new ol.source.TileImage({
                                crossOrigin: null,
                                extent: extent_23031_catalunya,
                                tileGrid: new ol.tilegrid.TileGrid({
                                    extent: extent_23031_catalunya,
                                    origin: [extent_23031_catalunya[0], extent_23031_catalunya[1]],
                                    resolutions: tms_resolutions_23031_catalunya
                                }),
                                tileUrlFunction: function (coordinate) {

                                    if (coordinate === null) return undefined;

                                    // TMS Style URL
                                    var z = coordinate[0];
                                    var x = coordinate[1];
                                    var y = coordinate[2];
                                    var url = 'http://10.10.1.113/mapproxy/tms/1.0.0/ly_cache_src_guia_urbana_municipal_64/grd_mataro/' + z + '/' + x + '/' + y + '.png';
                                    return url;
                                }
                            })
                        });
                        break;
                }   

                var capa = new ol.layer.Tile({
                    preload: 1,
                    opacity: 0.5,
                    source: new ol.source.TileImage({
                        crossOrigin: null,
                        extent: extent_23031_catalunya,
                        tileGrid: new ol.tilegrid.TileGrid({
                            extent: extent_23031_catalunya,
                            origin: [extent_23031_catalunya[0], extent_23031_catalunya[1]],
                            resolutions: tms_resolutions_23031_catalunya
                        }),
                        tileUrlFunction: function (coordinate) {
                            if (coordinate === null) return undefined;
                            // TMS Style URL
                            var z = coordinate[0];
                            var x = coordinate[1];
                            var y = coordinate[2];
                            var url = 'http://10.10.1.113/mapproxy/tms/1.0.0/ly_cache_src_historic_1852/grd_mataro/' + z + '/' + x + '/' + y + '.png';
                            return url;
                        }
                    })
                });
                
                
                /*
                 new ol.layer.Tile({
   title: 'Global Imagery',
   source: new ol.source.TileWMS({
     url: 'http://demo.opengeo.org/geoserver/wms',
     params: {LAYERS: 'ne:NE1_HR_LC_SR_W_DR', VERSION: '1.1.1'}
   })
 })
                */
                
                
                
                var capa2 =  new ol.layer.Tile({
                   title: 'Topogràfic1:1000',
                   source: new ol.source.TileWMS({
                     url: 'http://serveiswebdes.mataro.cat/cartografia/serveisTC/tilecache.fcgi',
                     params: {LAYERS: 'guia_urbana_municipal', VERSION: '1.1.1'}
                   })
                 });
                
                visor.map = new ol.Map({
                    layers: [ capa//,
                        //capa
                    ],
                    target: 'map',
                    view: new ol.View({
                        projection: visor.projection,
                        center: [454678, 4598832],
                        zoom: 14
                    })
                });
           
                // -- Event en fer click    
                //visor.map.on('click', function(e) {        
                //                        placeCamera(e);
                //                        recuperaAdreca(e.latlng);    
                //                    });
                             
                missatgePeuMapa( 'buscaPosicio' ); 
                setTimeout(function(){activaGeolocate();},1000);    
                
            }
            
            function activaGeolocate(){                
                visor.geolocation = new ol.Geolocation({
                    tracking: true
                });
                
                    //visor.geolocation.bindTo('projection', visor.map.getView());
                    visor.geolocation.on('change', function(evt) {
                    //save position and set map center
                    var pos = visor.geolocation.getPosition();
                    var postrans = ol.proj.transform( pos, "EPSG:4326", visor.projection);
                    visor.map.getView().setCenter(postrans);
                    var iconFeature = new ol.Feature({
                        geometry: new ol.geom.Point(postrans)
                    });
                
                    var vectorSource = new ol.source.Vector({
                        features: [iconFeature]
                    });
                    
                    visor.geolocationLayer = new ol.layer.Vector({
                        source: vectorSource
                    });
                    
                    visor.geolocationIconStyle = new ol.style.Style({
                        image: new ol.style.Icon({
                            anchor: [0.5, 46],
                            anchorXUnits: 'fraction',
                            anchorYUnits: 'pixels',
                            opacity: 0.75,
                            src: './images/locate.png'
                        })
                    });
                });
            } 

            function centraGeolocation(){
                visor.map.getView().setCenter(visor.geolocation.getPosition());
                visor.map.addLayer(visor.geolocationLayer);
            }    
                  
            
			
            function missatgePeuMapa( contingut, foto ){
			/*
                var txtPeu = '';
				
                switch ( contingut ) {
                    case 'fesFoto':
                        txtPeu =    ' <div onclick="uploadFromGallery();" style="width: 40%; margin-left: 30%; border-radius: 10px; color: rgb(255, 255, 255); text-shadow: 0px 0px rgb(0, 0, 0); background-color: rgb(196, 13, 1); padding: 0.3em 0em 0.5em; height: 1em; margin-bottom: 0.2em; margin-top: 0.2em;">'
                                   +    '    Foto  <i class="fa fa-camera "></i>'
                                   +    ' </div>';
                        break;
                    				
                    
                    case 'buscaPosicio':
                        txtPeu =    ' <div style="width: 100%; margin-left: 5%; color: rgb(115, 115, 115); text-shadow: 0px 0px rgb(0, 0, 0); background-color: rgb(255, 255, 255); padding: 0.5em 0em 0.5em; height: 1.3em; margin-bottom: 0.2em; margin-top: 0.2em;">'
                                   +    '    Buscant localització ... <i class="fa fa-spin fa-spinner"/>'
                                   +    ' </div>';
                        break;

                    case 'mostraFoto':
                        if ( foto == visor.data.length - 1 ) { foto = 1 }
                        if ( foto == 0 ) { foto = visor.data.length - 1 }
						// if ( foto < 9 && foto > 0 ) { 
                            var punt = visor.data[visor.data.length - foto];
							setTimeout(function(){visor.map.panTo([punt.den_y, punt.den_x]);},300);
                            var seguentFoto = foto + 1;
                            var anteriorFoto = foto - 1;
							txtPeu =  '   <div style="border-top: 3px solid #b91400;width:100%;height:215px;overflow:hidden"> '                                 
                                        + '     <div style="display: block; text-align: center; font-size: 1em; border-radius: 0px; bottom: 0px; left: 0px; width: 100%; opacity: 1; color: rgb(122, 122, 122); height: 0.3em; background-color: rgb(255, 255, 255);"></div>'
                                        + '     <div style="overflow:hidden;margin-top:1em;margin-left:1em;float:left;font-size:0.8em;height:86%;background-color:#ffffff;width:40%;text-align:left"> '
                                        + '         <div style="background-color:#ffffff;float:left;font-weight:bold;font-size:1.8em;height:1.3em;width:63%;text-align:left;margin-top:-0.2em">'
                                        + '            Avís: '
                                        +              foto
										+ '         </div>'
                                        + '         <div style="background-color:#ffffff;float:right;font-weight:bold;font-size:1.8em;height:1.3em;width:36%;text-align:left;margin-top:-0.2em">'
                                        + ' 		   <i class="fa fa-arrow-left" onclick="missatgePeuMapa( \'mostraFoto\','
                                        +              anteriorFoto 
                                        + '            );"/>'
                                        + ' 		   <i class="fa fa-arrow-right" onclick="missatgePeuMapa( \'mostraFoto\','
                                        +              seguentFoto 
                                        + '            );"/>'
										+ '         </div>'
                                        + '         <div style="float:left;font-weight:bold;font-size:1.0em;height:auto;background-color:#ffffff;width:100%;text-align:left;margin-top:-0.6em">'
                                        +               punt.data_imatge
                                        + '         </div>'
                                        + '         <div style="max-height:20%;overflow:hidden;clear: both; height: auto; background-color: rgb(255, 255, 255); width: 100%; text-align: left; margin-top: 3em; font-size: 0.7em;">'
                                        +               punt.adreca
                                        + '         </div>'
                                        + '         <div style="line-height:1em; clear: both;background-color: rgb(255, 255, 255); width: 100%; text-align: left; margin-top: 0.6em; font-size: 1em;height: 6.8em;overflow: hidden;">'
                                        + '             Fanal malmès per l\'estat de l\'asfalt i altres situacions visualitzades a la calçada.  Fanal malmès per l\'estat de l\'asfalt i altres situacions visualitzades a la calçada '
                                        + '         </div>   '
                                        + '     </div>   '                               
                                        + '     <div style="float:right;height:95%;overflow:hidden;width: 56%;background-color:#ffffff"> '
                                        + '         <img style="float:right;margin-right:1em;margin-top:0.5em; display:block;max-width:73%;max-height:90%;width:auto;height:auto;" src="http://issolutions.esy.es/ma/www/php/image/'
                                        +               punt.imatge 
                                        + '         " />'
                                        + '     </div>   '   
                                        + ' </div> ';
                        //        }       
                        break;
                    
                    default:
                        missatgePeuMapa( 'fesFoto' );
                        break;                                
                }

                $('#peuMapa').html( txtPeu );
                
				$('#peuMapa').show();
                ajustaFinestres(); 
            */   
            }
            
            function activaLocator(){
			// Activa la localització del plugin de leaflet 
				visor.locate = L.control.locate( {
					position: 'topright',  // set the location of the control
					drawCircle: true,  // controls whether a circle is drawn that shows the uncertainty about the location
					follow: false,  // follow the user's location
					setView: true, // automatically sets the map view to the user's location, enabled if `follow` is true
					keepCurrentZoomLevel: false, // keep the current map zoom level when displaying the user's location. (if `false`, use maxZoom)
					stopFollowingOnDrag: false, // stop following when the map is dragged if `follow` is true (deprecated, see below)
					remainActive: false, // if true locate control remains active on click even if the user's location is in view.
					markerClass: L.marker, // L.circleMarker or L.marker
					circleStyle: {},  // change the style of the circle around the user's location
					markerStyle: {},
					followCircleStyle: {},  // set difference for the style of the circle around the user's location while following
					followMarkerStyle: {},
					icon: 'fa fa-map-marker',  // class for icon, fa-location-arrow or fa-map-marker
					iconLoading: 'fa fa-spinner fa-spin',  // class for loading icon
					circlePadding: [0, 0], // padding around accuracy circle, value is passed to setBounds
					metric: true,  // use metric or imperial units
					onLocationError: function(err) {alert('Error en el posicionament');},  // define an error callback function
					onLocationOutsideMapBounds:  function(context) { // called when outside map boundaries
					//alert(context.options.strings.outsideMapBoundsMsg);
					},
					showPopup: true, // display a popup when the user click on the inner marker
					strings: {
						title: "Troba la meva posició",  // title of the locate control
						metersUnit: "meters", // string for metric units
						feetUnit: "feet", // string for imperial units
						popup: "Posició Actual",  // text to appear if user clicks on circle
						outsideMapBoundsMsg: "Et trobes fora dels límits del mapa" // default message for onLocationOutsideMapBounds
					},
					locateOptions: {maximumAge: 3000, timeout: 5000, enableHighAccuracy: true }  // define location options e.g enableHighAccuracy: true or maxZoom: 10
				});
				
				//-- Incorpora el control al mapa
				visor.locate.addTo(visor.map);
                visor.locate.start();
				
				//-- Funció quan troba la posició
				visor.map.on('locationfound', posicioTrobada);
			}  			

            // -- Recupera la posició actual i la introdueix a les variables corresponents
            function posicioTrobada(e) {
                //visor.alertaBuscantPosicio == 0 ? alert('BuscantPosició') : null;
                var latitude = e.latlng.lat;
                var longitude = e.latlng.lng;
                var estatAnterior = visor.posicioActual.trobat;
                visor.posicioActual =   { 'trobat' : 1,
                                        'lat' : latitude,
                                        'lng' : longitude
                                        };
                                        
                if (latitude == 0 ) {                   
                    visor.posicioActual = { 'trobat' : 0,
                                        'lat' : 41.24 ,
                                        'lng' : 2.1,
                                    };      
                }
                else {
                } 
                if ( visor.primeraUbicació ==  1){
                    missatgePeuMapa('');
                    placeCamera(e);
                    visor.primeraUbicació = 0;
                }            
            } 
            //-- Mostra la icona en el punt actual TODO: unificar funció anterior
			
            function centraPosicio(punt,zoom){
                visor.map.setView(punt, zoom);
                if (visor.markerPosicioActualPresent == '0' ){
                    visor.markerPosicioActualPresent = '1';
                    var iconSizeX = 30;
                    var iconSizeY = 45;             
                    var iconMap = L.icon({
                        iconUrl: 'images/mypos.png' ,
                        shadowUrl: 'images/marker-shadow.png',
                        iconSize:     [iconSizeX, iconSizeY], // size of the icon
                        shadowSize:   [32, 32], // size of the shadow
                        iconAnchor:   [15, 45], // point of the icon which will correspond to marker's location
                        shadowAnchor: [10, 30],  // the same for the shadow
                        popupAnchor:  [0, -45 ] // point from which the popup should open relative to the iconAnchor
                    });       
                            
                    //L.marker().addTo(visor.map)
                    visor.markerPosicioActual = L.marker(e.latlng,{icon:iconMap})
                        .addTo(visor.map)
                        .bindPopup(
                            "<h2 style='font-family:Arial;font-size:1.5em;height:20px'>" 
                            + ' La teva posició'  
                            +  " <img width='30' src='images/troba.png' style='float:left;margin-right:2em'/ >" 
                            + "</h2>" 
                            + ' Posició actual aproximada'                  
                            );
                }
            }

            function mostraPosicioActual(){            
                if (visor.posicioActual.trobat == 1) { 
                    centraPosicio(visor.posicioActual,17);
                }
                else{
                    //activaGeoposicionament();
                }
            }     
            
            // /* Recupera el text de l'adreça propera segons OpenStreetMap            
            function recuperaAdreca(punt){ 
                $.getJSON("http://nominatim.openstreetmap.org/reverse?json_callback=?", 
                    { format: "json", lat: punt.lat, lon: punt.lng, zoom: 18, addressdetails: 1 },
                    function(data) { 
                        visor.adrecaOSM =  data.display_name.replace(/'/g, "\\'");
                });               
            }
           
            //-- Retorna els errors de posicionament
            function onLocationError(e) {
                alert(e.message);
            }

            //-- Enviament de la imatge i actualització de la base de dades
            /*
            function uploadFromGallery_2() {
                //Retrieve image file location from specified source
                navigator.camera.getPicture(    uploadPhoto,
                                                function(message) { alert('get picture failed'); },
                                                {   quality: 50,                                            
                                                    destinationType: navigator.camera.DestinationType.FILE_URI,
                                                    sourceType: navigator.camera.PictureSourceType.PHOTOLIBRARY }
                                                );
            }
            */
            
            function uploadFromGallery() {
                // Retrieve image file location from specified source
                navigator.camera.getPicture(    uploadPhoto,
                                                function(message) { alert("Problemes amb l'enviament"); },
                                                {   quality: 50, 
                                                    targetWidth: 1024,
                                                    targetHeight: 1024,
                                                    destinationType: navigator.camera.DestinationType.FILE_URI,
                                                    sourceType: navigator.camera.PictureSourceType.CAMERA,
                                                    mediaType: navigator.camera.MediaType.ALLMEDIA
                                                }
                                            );				  
            }
			
            function uploadPhoto(imageURI) {
                var options = new FileUploadOptions();
                //var options = {};
				options.fileKey="file";
                options.fileName=imageURI.substr(imageURI.lastIndexOf('/')+1);//+'.png';
                options.mimeType="image/jpeg";
				options.headers = { Connection: "close" };
                var params = {};
                params.codi= 'Joan';
                params.usuari_codi = 'Gomis';
				params.adreca = visor.adrecaOSM;
                params.descripcio = 'Simulació de descripcio';
                params.imatge = options.fileName;//file.name;
                params.den_x = parseFloat(visor.posicioCamera.lng);
                params.den_y = parseFloat(visor.posicioCamera.lat);
                params.usu_x = parseFloat(visor.posicioCamera.lng);
                params.usu_y = parseFloat(visor.posicioCamera.lat);                
                options.params = params;
				visor.params = params;
                var ft = new FileTransfer();
                ft.upload(imageURI, encodeURI("http://issolutions.esy.es/ma/www/php/upload.php"), ftWin, ftFail, options,true);                                       
            } 

            function ftWin(r) {
                console.log("Code = " + r.responseCode);
                console.log("Response = " + r.response);
                console.log("Sent = " + r.bytesSent);
				$.ajax({
					url: "http://issolutions.esy.es/ma/www/php/insert.php", 
					type: "POST",
					data: visor.params,
					success: function(){
						recuperaElements();
						setTimeout(function(){missatgePeuMapa( 'mostraFoto', 1 );}, 500);//creaImatgePujada(visor.params);
					},
					error: function(xhr, textStatus, errorThrown){
						alert("Error detectat. Puja-la de nou." + xhr.responseText 
							+ "\nstatus: " + textStatus 
							+ "\nerror: " + errorThrown);
					}                                       
				});             				
            }

            function ftFail(error) {
                alert("La imatge no s'ha pujat. Intenta-ho de nou");
                //console.log("upload error source " + error.source);
                //console.log("upload error target " + error.target);
            }       

            //-- Ajax per recuperar punts 
            function recuperaElements() {
                visor.map.removeLayer(visor.totMarker);
                $.ajax({
                    type: "POST",
                    url: "http://issolutions.esy.es/ma/www/php/select.php",
                    contentType: "application/json; charset=ISO-8859-1",
                    dataType: "json",
                    success: function( data ) {                   
                        visor.data = data;
                        visor.totMarker = new L.FeatureGroup();
                        var iconSizeX = 30;
                        var iconSizeY = 45;             
                        var iconMap = L.icon({
                            iconUrl: 'images/marker-icon-red.png' ,
                            shadowUrl: 'images/marker-shadow.png',
                            iconSize:     [iconSizeX, iconSizeY], // size of the icon
                            shadowSize:   [32, 32],  // size of the shadow
                            iconAnchor:   [15, 45],  // point of the icon which will correspond to marker's location
                            shadowAnchor: [ 10, 30], // the same for the shadow
                            popupAnchor:  [ 0,-45]   // point from which the popup should open relative to the iconAnchor
                        });       
                        
                        $.each(visor.data,function(i,punt){
                            var marker = L.marker([punt.den_y, punt.den_x],{icon: iconMap})
                                .bindPopup('  <div>'
                                            +     punt.data_imatge
                                            + '</div>'
                                            + '<div><b>'
                                            + punt.adreca
                                            + '</b></div>'
                                            +    '<img width=150 onerror="alert(\'Pujant la imatge ...\')" src="http://issolutions.esy.es/ma/www/php/image/' 
                                            +       punt.imatge 
                                            +       '?d='
                                            +       new Date().getTime() // TODO: Per refrescar cache (optimitzar-ho amb onerror)                                            
                                            + '" />');
                            visor.totMarker.addLayer(marker);
                            visor.map.addLayer(visor.totMarker);
                        });
                    }
                });
            }  
            
            function creaImatgePujada(params) {
                $('#divImatgePujada').prepend( '     <div class="divContImatge" style="width=100%;height:auto"> '
                                            + '         <div class="divContImatgeTitol" style="font-size:14px;height:30px;"> '
                                            + '             Dades de la Imatge Pujada '
                                            + '         </div> '
                                            + '         <div class="divContImatgeDades" style="font-size:12px;height:auto;margin-left:20px;margin-bottom:10px;"> '
                                            + '             <p><b> Nom: </b>' 
                                            +                   params.adreca
                                            + '             </p> '      
                                            + '         </div> '
                                            + '         <div class="divContImatgeDades" style="font-size:12px;height:auto;margin-left:20px;margin-bottom:10px;"> '
                                            + '             <p><b> Adreça: </b>' 
                                            +                   params.codi
                                            + '             </p> '      
                                            + '         </div> '
                                            + '         <div class="divContImatgeDades" style="font-size:12px;height:auto;margin-left:20px;margin-bottom:10px;"> '
                                            + '             <p><b> Codi Usuari: </b>' 
                                            +                   params.usuari_codi
                                            + '             </p> '      
                                            + '         </div> '                                            
                                            + '         <div class="divContImatgeCoords" style="font-size:12px;height:20px;margin-left:20px;margin-bottom:10px;"> '
                                            + '             <p><b> Longitud: </b>' 
                                            +               params.den_x
                                            + '             <b> Latitud: </b>'                                      
                                            +               params.den_y
                                            + '             </p> '      
                                            + '         </div> '
                                            + '         <div class="divImatge" style="width:100%;height:auto;margin-left:20px; "> '
                                            + '             <img width=300 src="http://issolutions.esy.es/ma/www/php/image/'                                   
                                            +                   params.imatge
                                            + '             "></img>'
                                            + '          </div> '
                                            + '     </div>');
                                            
                // $.mobile.changePage($('#imatgePujada'),'pop'); Per ara bloquejat - Nomostra les dades de la imatge pujada per deixar temps a que pugi a l'aplicació
            }
            
            // Creació del llistat de punts 
            function creaRelacioPunts(){
                $.each(visor.data,function(i,punt){
                    /*var puntMapa = $('<div/>')
                        .addClass('llistaElementMapa')
                        .html('<div>'
                                + 'punt'   
                                +'<img width=70 src="' 
                                + punt.vc_imatge 
                                + '"/>'
                                + '</div>') 
                        .appendTo($('#relacioPuntsMapa'));      
                    */
                    
                    $('#relacioPuntsMapa').append(    '  <ol data-role="listview"> '
                                                    + '     <li>'
                                                    + '         <a href="#"> List Item '
                                                    +               i
                                                    + '             <img width=70 src="http://issolutions.esy.es/ma/www/php/image/' 
                                                    +                   punt.imatge 
 //                                                   + '#'
 //                                                   + new Date().getTime() // TODO: Per refrescar cache (optimitzar-ho amb on error)
                                                    + '             " />'                                                
                                                    + '         </a>'
                                                    + '     </li>'
                                                    + '  </ol>');
                });
                $('#relacioPuntsMapa').height($(window).height() - 250);    
            }
            
            // Situar la icona de la càmera
            function placeCamera(e){
                visor.map.removeLayer(visor.markerCamera);
                var iconSizeX = 30;
                var iconSizeY = 30;             
                var iconMap = L.icon({
                    iconUrl: 'images/camera-icon.png',
                    iconSize:     [iconSizeX, iconSizeY], 	// size of the icon
                    shadowSize:   [32, 32], 				// size of the shadow
                    iconAnchor:   [15, 15], 				// point of the icon which will correspond to marker's location
                    shadowAnchor: [10, 30],  				// the same for the shadow
                    popupAnchor:  [-0 , -16 ] 				// point from which the popup should open relative to the iconAnchor
                });       

                visor.markerCamera = L.marker(e.latlng,{icon:iconMap})
                    .addTo(visor.map)
                    .bindPopup(
                        "<h2 style='font-family:Arial;font-size:1.2em;height:auto;width:200px'>" 
                        +  " <img width='30' src='images/camera-icon.png' style='float:left;margin-right:2em'/ >"   
                        + ' Indret on es farà la fotografia'  
                        + "</h2>" 
                        + ''                    
                        )
                    .on('click', uploadFromGallery);
                visor.posicioCamera = e.latlng;
               // missatgePeuMapa('<a class="btn btn-danger" onclick="uploadfromGallery()"> <img class="" src="images/camera-icon.png" style=" width: 30px; height: 30px;" />Captura </a>' );
                missatgePeuMapa( 'fesFoto' )                
                ajustaFinestres();    
            }

    

    </script>
    
    </head>
    
    <body style="font-family:arial">
        <!--------------------------------  Pàgina Portada ---------------------------------------->     
        <div data-role="page" id="portada" style="width:100%;height:100%;margin:0px;background-color:#ffffff;overflow:hidden">  
            <div id="fotoPortada" style="width:100%;height:70%;">
				<div style="height:10%;width100%"></div>
					<div style="height:70%;width:100%;">
						<a href="#pageMap">    
                            <div style="float:left;height:100%;max-width:130%;overflow:hidden;text-align:center">
                                <img width=80% src="images/logo.jpg" />
                            </div>
                       </a>     
				</div> 
            </div>
            <div style="float:left;height:10%;width:10%;"></div>
            <div style="text-align:center; color:0176bb; font-size:2em; width: 100%; height: 30%; color: #337799;">
                <div style="margin-top:7%;margin-left:10%;width:80%; height:auto;font-size:2.2em;">visorSIG</div>
                <div style="width: 80%; margin-left: 10%; height: auto; font-size: 0.8em; line-height: 0.9em;"> Ajuntament de Mataró </div>
            </div>
			<div style="position:absolute;bottom:4px;right:10px;text-align:right; overflow:hidden;color: rgb(255, 255, 255); font-size:0.8em; width: 100%; margin-left:10%; height: auto;"> Prototip desenvolupat pel SSIT </div>
        </div>
        
        <!--------------------------------  Pàgina Mapa ------------------------------------------->     
        <div data-role="page" id="pageMap" > 
            <!------------------ Header --------------->    
			<div id="header" style="border-width: 0px; height:2.3em;background-color: #0176bb; color: rgb(250, 250, 250); font-family: inherit; font-size: 1.1em; font-weight: lighter; text-shadow: 0px 0px; z-index: 1; " role="banner" data-role="header" class="ui-header ui-bar-inherit">
				<div id="troba4" style="float: left; height:24px ; font-size: 1.5em; width: 5%;" onclick="recuperaElements();">
					<img width="34" style="margin-left: 4px; margin-top:3px;" src="icon.png">
				</div>
				<div style="float: left; height: auto; text-align: left; padding-top: 0px; font-family: Verdana; color: rgb(220, 70, 0); width: 100%; margin-left:-5%;float: left; ">
					<div style="float: left; font-weight:bold; text-align: center; font-family: Verdana; color: rgb(255, 255, 255); width: 100%; height: 1.1em; margin-top: 0.3em;">Ajuntament de Mataró </div>
					<div style="clear: both; text-align: center; font-family: Verdana; color: rgb(255, 255, 255); font-size: 0.6em; width: 100%; height: 15px; margin-top: -1px;"> Visualització sobre mòbil </div>
				</div>
			</div>
            
            <!------------------ Content --------------->
             <div data-role="content" id="contMapa" style="border-top:1px solid rgb(211,211,211);clear:both;padding:0px"> 
                <div class="caixaControl" >             
                    <!--div id="troba1" class="controlMapa" onclick="visor.map.zoomIn();">+</div>
                    <!--div id="troba2" class="controlMapa controlMapa-junt" onclick="visor.map.zoomOut()">-</div -->
                    <div id="troba3" class="controlMapa controlMapa-separat" onclick="centraGeolocation()">
                        <img width=44 src="images/locate.png">
                    </div>
                </div>
                <div id="map" style="width:100%;height:100%"></div>           
            </div>
            
            <!------------------ Footer --------------->

            <!--div data-role="footer" --> 
                <div id="peuMapa" style="height:auto; box-shadow:0px 5px 12px 4px #232323;display:block;position: fixed; text-align: center; font-size: 1.1em; background-color: rgb(255, 255, 255); border-radius: 0px; bottom: 0px; left: 0px; width: 100%; opacity: 1; color: rgb(122, 122, 122);">

                </div>
            <!--/div-->
        </div>


        
        <!--------------------------------  Pàgina Detall Element --------------------------------->        
        <div data-role="page" data-dialog="true" id="llistaElements"> 
            <div data-role="header"  role="banner" id = "headerDetail" style="z-index: 1; box-shadow:0px 2px 6px #444444;">         
                <!--div data-inline="true" value="on"  style="" checked="checked" type="radio" onclick=" visor.mapDetail.setView([visor.posicioActual.lat, visor.posicioActual.lng], 20);" href="#" class="ui-btn-right ui-btn ui-icon-navigation ui-btn-icon-left ui-shadow ui-corner-all "> Troba'm </div>    
                <h1 class="ui-title" role="heading" aria-level="1">Elements visibles en el mapa</h1> 
                <a href="#pageList"  class="ui-btn ui-icon-bullets ui-btn-icon-left ui-shadow ui-corner-all">Llista</a>
                <div data-type="horizontal" data-role="controlgroup" style="position:absolute;top:47px;right:3px;">
                    <a value="on"  checked="checked" type="radio" onclick="baseLayerDetail(visor.config.layers.base[3])" href="#" class="ui-btn ">Map</a>
                    <a value="off" checked="checked" type="radio" onclick="baseLayerDetail(visor.config.layers.base[0])" href="#" class="ui-btn ">Sat</a>
                </div-->
                 <h1>Elements en el mapa</h1>           
            </div>
            

            <div data-role="content" id="contMapDetail"> 
                <div id="relacioPuntsMapa" style="height:300px"></div>              
            </div>
            <div data-role="footer">
                <h1>Tots els elements trobats</h1>
            </div>
            

            <!--div data-role="footer"  id = "footer" style="box-shadow: 0 0 8px 2px rgb(68, 68, 68);"> 
                <div data-type="horizontal" data-role="controlgroup" style="text-align:center;">    
                    <a onclick="nextOverlayLayer(-1)" href="#" style="width:30px;height:16px;"  class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-icon-arrow-l"></a>
                    <a style="margin-top: 0px;width:120px" id="layerName"   class="ui-btn ">Layers</a>
                    <a onclick="nextOverlayLayer(1)" href="#" style="width:30px;height:16px;" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-icon-arrow-r"></a>
                </div>          
            </div-->            
        </div>
        <!--  Pàgina Imatge Pujada -->      
        <div data-role="page" data-dialog="true" id="imatgePujada"> 
            <div data-role="header"  role="banner" id ="headerImatgePujada" style="z-index: 1; box-shadow:0px 2px 6px #444444;">                
                <!--div data-inline="true" value="on"  style="" checked="checked" type="radio" onclick=" visor.mapDetail.setView([visor.posicioActual.lat, visor.posicioActual.lng], 20);" href="#" class="ui-btn-right ui-btn ui-icon-navigation ui-btn-icon-left ui-shadow ui-corner-all "> Troba'm </div>    
                <h1 class="ui-title" role="heading" aria-level="1">Elements visibles en el mapa</h1> 
                <a href="#pageList"  class="ui-btn ui-icon-bullets ui-btn-icon-left ui-shadow ui-corner-all">Llista</a>
                <div data-type="horizontal" data-role="controlgroup" style="position:absolute;top:47px;right:3px;">
                    <a value="on"  checked="checked" type="radio" onclick="baseLayerDetail(visor.config.layers.base[3])" href="#" class="ui-btn ">Map</a>
                    <a value="off" checked="checked" type="radio" onclick="baseLayerDetail(visor.config.layers.base[0])" href="#" class="ui-btn ">Sat</a>
                </div-->
                 <h1>Dades de la Imatge pujada</h1>         
            </div>
            

            <div data-role="content" id="contImatgePujada"> 
                <div id="divImatgePujada" style="height:300px"></div>               
            </div>
            <div data-role="footer">
                <h1>Dades enregistrades</h1>
                <h1>Dades enregistrades</h1>
            </div>
            

            <!--div data-role="footer"  id = "footer" style="box-shadow: 0 0 8px 2px rgb(68, 68, 68);"> 
                <div data-type="horizontal" data-role="controlgroup" style="text-align:center;">    
                    <a onclick="nextOverlayLayer(-1)" href="#" style="width:30px;height:16px;"  class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-icon-arrow-l"></a>
                    <a style="margin-top: 0px;width:120px" id="layerName"   class="ui-btn ">Layers</a>
                    <a onclick="nextOverlayLayer(1)" href="#" style="width:30px;height:16px;" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-icon-arrow-r"></a>
                </div>          
            </div-->            
        </div>  
    </body>
</html>   


